# إصلاح مشكلة حفظ الفاتورة - Invoice Save Fix

## المشكلة
عند محاولة حفظ الفاتورة، يظهر خطأ: "في حفظ الفاتورة بيطلع الايرور ده لما اتكي حفظ"

## السبب
1. دالة `generate_invoice_number()` غير موجودة في قاعدة البيانات
2. جداول نظام الفواتير غير موجودة أو غير مكتملة
3. مشاكل في RLS (Row Level Security)

## الحل السريع

### الخطوة 1: تنفيذ ملف الإصلاح
قم بتنفيذ الملف التالي في Supabase SQL Editor:

**`database/QUICK_INVOICE_FIX.sql`**

هذا الملف يحل جميع المشاكل دفعة واحدة.

### الخطوة 2: التحقق من الإصلاح
بعد التنفيذ، يجب أن ترى رسالة:
```
تم إنشاء نظام الفواتير بنجاح!
اختبار دالة توليد رقم الفاتورة:
INV-202412-0001 (أو رقم مشابه)
```

## ما يتم إصلاحه

### 1. إنشاء الجداول
- `invoices` - جدول الفواتير الرئيسي
- `invoice_items` - جدول عناصر الفواتير

### 2. إنشاء الدوال
- `generate_invoice_number()` - توليد رقم فاتورة تلقائي
- `calculate_invoice_totals()` - حساب إجماليات الفاتورة

### 3. إنشاء المحفزات
- `trigger_update_invoice_totals` - تحديث الإجماليات تلقائياً

### 4. إعداد الأمان
- RLS policies للفواتير وعناصرها
- منح الصلاحيات للمستخدمين المعتمدين

### 5. إنشاء الفهارس
- فهارس للأداء الأمثل

## إذا استمرت المشكلة

### 1. تحقق من Console
افتح Developer Tools (F12) وانتقل إلى Console لرؤية الخطأ الكامل.

### 2. تحقق من Network
في Developer Tools، انتقل إلى Network لرؤية طلبات API.

### 3. تحقق من Authentication
تأكد من تسجيل الدخول بشكل صحيح.

## رسائل الخطأ الشائعة

### "function generate_invoice_number() does not exist"
**الحل:** تنفيذ ملف `QUICK_INVOICE_FIX.sql`

### "relation 'invoices' does not exist"
**الحل:** تنفيذ ملف `QUICK_INVOICE_FIX.sql`

### "permission denied"
**الحل:** تأكد من تسجيل الدخول وتنفيذ ملف `QUICK_INVOICE_FIX.sql`

## اختبار النظام

بعد الإصلاح، جرب:
1. إنشاء فاتورة جديدة
2. إضافة منتجات
3. حفظ الفاتورة
4. طباعة الفاتورة

## ملاحظات مهمة

- تأكد من وجود منتجات في جدول `products`
- تأكد من تسجيل الدخول قبل إنشاء الفواتير
- النظام يدعم الخصومات على مستوى العنصر والفاتورة
- يتم توليد أرقام الفواتير تلقائياً بالصيغة: `INV-YYYYMM-XXXX`

## الدعم

إذا استمرت المشكلة، قم بـ:
1. التقاط صورة للخطأ في Console
2. التقاط صورة للخطأ في Network
3. مشاركة التفاصيل مع فريق الدعم

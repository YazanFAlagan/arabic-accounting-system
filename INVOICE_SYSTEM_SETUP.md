# نظام الفواتير متعددة الأصناف
## Multi-Item Invoice System

### نظرة عامة
تم تطوير نظام فواتير شامل يدعم بيع عدة أصناف في فاتورة واحدة، مما يجعل النظام أكثر عملية وواقعية للاستخدام التجاري.

### الميزات الجديدة

#### 1. نظام الفواتير المتقدم
- **فواتير متعددة الأصناف**: إمكانية إضافة عدة منتجات في فاتورة واحدة
- **ترقيم تلقائي للفواتير**: نظام ترقيم ذكي بصيغة `INV-YYYYMM-0001`
- **أنواع بيع متعددة**: دعم البيع بالجملة والقطاعي والمحلات
- **نظام خصومات متدرج**:
  - خصم على مستوى العنصر الواحد (نسبة + مبلغ)
  - خصم إضافي على إجمالي الفاتورة (نسبة + مبلغ)

#### 2. إدارة المخزون المحسنة
- **تحديث تلقائي للمخزون**: خصم الكميات تلقائياً عند إنشاء الفاتورة
- **تتبع دقيق للمخزون**: إرجاع الكميات عند تعديل أو حذف الفواتير
- **تحديث الأسعار التلقائي**: تغيير الأسعار تلقائياً عند تغيير نوع البيع

#### 3. حسابات مالية دقيقة
- **حساب تلقائي للإجماليات**: حساب المجاميع والخصومات تلقائياً
- **ملخص فاتورة تفصيلي**: عرض تفصيلي لجميع العناصر والخصومات
- **عملة مصرية**: تنسيق الأسعار بالجنيه المصري

### خطوات التطبيق

#### 1. تحديث قاعدة البيانات
قم بتشغيل الملف SQL التالي في Supabase:
```sql
-- تطبيق نظام الفواتير
psql -h [SUPABASE_HOST] -U postgres -d postgres -f database/invoice_system_schema.sql
```

أو قم بنسخ ولصق محتويات `database/invoice_system_schema.sql` في SQL Editor في Supabase.

#### 2. إضافة صفحة الفواتير للتنقل
أضف رابط صفحة الفواتير إلى نظام التنقل في `src/components/QuickNavigation.tsx`:

```tsx
// إضافة هذا الرابط إلى قائمة التنقل
{
  name: 'الفواتير',
  href: '/invoices',
  icon: FileText,
  color: 'text-purple-600',
  bgColor: 'bg-purple-100'
}
```

### الهيكل الجديد لقاعدة البيانات

#### جدول الفواتير (invoices)
```sql
- id: UUID (معرف فريد)
- invoice_number: VARCHAR(50) (رقم الفاتورة)
- customer_name: VARCHAR(255) (اسم العميل)
- invoice_date: DATE (تاريخ الفاتورة)
- sale_type: VARCHAR(20) (نوع البيع: wholesale/retail/shop)
- subtotal: DECIMAL(10,2) (المجموع قبل الخصم)
- discount_percentage: DECIMAL(5,2) (خصم نسبة مئوية)
- discount_amount: DECIMAL(10,2) (خصم مبلغ ثابت)
- total_amount: DECIMAL(10,2) (المجموع النهائي)
- notes: TEXT (ملاحظات)
- status: VARCHAR(20) (حالة الفاتورة)
```

#### جدول عناصر الفواتير (invoice_items)
```sql
- id: UUID (معرف فريد)
- invoice_id: UUID (معرف الفاتورة)
- product_id: UUID (معرف المنتج)
- product_name: VARCHAR(255) (اسم المنتج)
- quantity: INTEGER (الكمية)
- unit_price: DECIMAL(10,2) (سعر الوحدة)
- item_discount_percentage: DECIMAL(5,2) (خصم نسبة مئوية)
- item_discount_amount: DECIMAL(10,2) (خصم مبلغ ثابت)
- final_unit_price: DECIMAL(10,2) (السعر النهائي)
- line_total: DECIMAL(10,2) (إجمالي السطر)
```

### الدوال والمحفزات الجديدة

#### 1. دالة توليد رقم الفاتورة
```sql
generate_invoice_number()
```
- تولد رقم فاتورة فريد بصيغة `INV-YYYYMM-0001`
- تتزايد تلقائياً لكل شهر

#### 2. دالة حساب إجماليات الفاتورة
```sql
calculate_invoice_totals(invoice_id)
```
- تحسب المجموع الفرعي من جميع العناصر
- تطبق الخصومات على مستوى الفاتورة
- تحدث المجموع النهائي تلقائياً

#### 3. محفزات تحديث المخزون
```sql
trigger_update_stock_on_invoice_change
```
- يحدث المخزون تلقائياً عند إضافة/تعديل/حذف عناصر الفاتورة
- يضمن دقة أرقام المخزون

#### 4. محفزات تحديث الإجماليات
```sql
trigger_update_invoice_totals
```
- يحدث إجماليات الفاتورة تلقائياً عند تغيير العناصر
- يضمن دقة الحسابات المالية

### العروض (Views) الجديدة

#### 1. ملخص الفواتير (invoices_summary)
```sql
SELECT 
  i.*,
  COUNT(ii.id) as items_count,
  SUM(ii.quantity) as total_quantity
FROM invoices i
LEFT JOIN invoice_items ii ON i.id = ii.invoice_id
```

#### 2. الفواتير التفصيلية (invoices_detailed)
```sql
SELECT 
  i.*,
  ii.*,
  p.current_stock,
  p.wholesale_price,
  p.retail_price,
  p.shop_price
FROM invoices i
LEFT JOIN invoice_items ii ON i.id = ii.invoice_id
LEFT JOIN products p ON ii.product_id = p.id
```

### واجهة المستخدم

#### صفحة الفواتير الجديدة (`/invoices`)
- ✅ عرض جميع الفواتير في جدول منظم
- ✅ بحث في الفواتير بالاسم أو رقم الفاتورة
- ✅ إنشاء فاتورة جديدة بواجهة سهلة الاستخدام
- ✅ إضافة عدة أصناف في فاتورة واحدة
- ✅ حساب تلقائي للأسعار والخصومات
- ✅ ملخص فاتورة تفصيلي

#### مكونات الواجهة
1. **نموذج إنشاء الفاتورة**:
   - معلومات العميل والتاريخ
   - اختيار نوع البيع
   - إضافة الأصناف مع الخصومات
   - حساب الإجماليات تلقائياً

2. **جدول عناصر الفاتورة**:
   - عرض جميع الأصناف المضافة
   - إمكانية حذف الأصناف
   - عرض الأسعار والخصومات

3. **ملخص الفاتورة**:
   - المجموع الفرعي
   - الخصومات التفصيلية
   - المجموع النهائي

### كيفية الاستخدام

#### 1. إنشاء فاتورة جديدة
1. اذهب إلى صفحة الفواتير `/invoices`
2. اضغط "إنشاء فاتورة جديدة"
3. أدخل اسم العميل وتاريخ الفاتورة
4. اختر نوع البيع (قطاعي/جملة/محلات)

#### 2. إضافة الأصناف
1. اختر المنتج من القائمة المنسدلة
2. أدخل الكمية المطلوبة
3. أضف خصم إذا لزم الأمر (نسبة أو مبلغ)
4. اضغط "إضافة" لإضافة الصنف للفاتورة
5. كرر العملية لإضافة أصناف أخرى

#### 3. تطبيق خصومات إضافية
1. في قسم "ملخص الفاتورة"
2. أدخل خصم إضافي على إجمالي الفاتورة
3. يمكن الجمع بين خصم النسبة والمبلغ الثابت

#### 4. حفظ الفاتورة
1. تأكد من صحة جميع البيانات
2. اضغط "حفظ الفاتورة"
3. سيتم تحديث المخزون تلقائياً

### الملفات المنشأة والمحدثة

#### قاعدة البيانات
- `database/invoice_system_schema.sql` - نظام الفواتير الكامل

#### الواجهات
- `src/app/invoices/page.tsx` - صفحة الفواتير الرئيسية
- `src/app/invoices/InvoiceForm.tsx` - نموذج إنشاء الفاتورة

#### التوثيق
- `INVOICE_SYSTEM_SETUP.md` - دليل الإعداد والاستخدام

### المتطلبات التقنية
- Next.js 13+
- Supabase
- TypeScript
- Tailwind CSS
- React Hooks

### الأمان والأداء

#### الأمان
- ✅ Row Level Security (RLS) على جميع الجداول
- ✅ سياسات أمان منفصلة للمستخدمين
- ✅ حماية من الوصول غير المصرح

#### الأداء
- ✅ فهارس محسنة للبحث السريع
- ✅ محفزات فعالة لتحديث البيانات
- ✅ عروض محسنة للاستعلامات المعقدة

### اختبار النظام

#### 1. اختبار إنشاء فاتورة
1. انتقل إلى `/invoices`
2. أنشئ فاتورة جديدة
3. أضف عدة أصناف مختلفة
4. طبق خصومات متنوعة
5. احفظ الفاتورة

#### 2. اختبار تحديث المخزون
1. تحقق من المخزون قبل الفاتورة
2. أنشئ فاتورة بكميات محددة
3. تحقق من تحديث المخزون تلقائياً

#### 3. اختبار الحسابات
1. أنشئ فاتورة بأصناف متعددة
2. طبق خصومات مختلفة
3. تحقق من دقة الحسابات

### الدعم والصيانة

#### مشاكل محتملة وحلولها
1. **عدم ظهور الفواتير**: تأكد من تطبيق SQL schema
2. **أخطاء في الحسابات**: تحقق من دوال calculate_invoice_totals
3. **عدم تحديث المخزون**: تحقق من محفزات update_stock

#### التطوير المستقبلي
- إضافة طباعة الفواتير
- تصدير الفواتير PDF
- تقارير مبيعات متقدمة
- إشعارات المخزون المنخفض

### الخلاصة
نظام الفواتير الجديد يوفر:
- ✅ فواتير متعددة الأصناف احترافية
- ✅ إدارة مخزون دقيقة ومتقدمة  
- ✅ حسابات مالية شاملة ودقيقة
- ✅ واجهة مستخدم سهلة وعملية
- ✅ أمان وأداء محسن

النظام جاهز للاستخدام الفوري بعد تطبيق تحديثات قاعدة البيانات!

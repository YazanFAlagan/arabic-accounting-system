# نظام الأرباح والأموال المتاحة - Profit and Available Funds System

## نظرة عامة
تم تحديث نظام الفواتير ليشمل حساب الأرباح والأموال المتاحة بناءً على طلبك.

## الميزات الجديدة

### 1. الأموال المتاحة (Available Funds)
- **التعريف**: المبلغ الكامل من بيع المنتج (سعر البيع × الكمية)
- **المعادلة**: `الأموال المتاحة = سعر البيع × الكمية`
- **المعنى**: الأموال التي تم تحصيلها من العميل

### 2. الأرباح (Profit)
- **التعريف**: الفرق بين سعر البيع وتكلفة الشراء
- **المعادلة**: `الربح = (سعر البيع × الكمية) - (تكلفة الشراء × الكمية)`
- **المعنى**: صافي الربح بعد خصم التكلفة

### 3. الإحصائيات الجديدة
- إجمالي الأرباح
- الأموال المتاحة الإجمالية
- عدد الفواتير
- إجمالي الإيرادات
- إجمالي الكميات

## متطلبات قاعدة البيانات

### إضافة عمود تكلفة الوحدة
```sql
-- تشغيل الملف: database/add_unit_cost_column.sql
-- هذا سيضيف عمود unit_cost إلى جدول products
```

### هيكل البيانات المطلوب
```sql
-- جدول المنتجات
products.unit_cost -- تكلفة شراء الوحدة

-- جدول الفواتير (يتم حسابه تلقائياً)
invoices.total_profit -- إجمالي الربح
invoices.available_funds -- الأموال المتاحة
```

## كيفية الاستخدام

### 1. إعداد تكلفة المنتجات
- اذهب إلى صفحة المخزون
- أضف تكلفة الشراء لكل منتج
- أو استخدم الملف SQL لتحديث تلقائي

### 2. عرض الإحصائيات
- صفحة الفواتير تعرض 5 بطاقات إحصائية
- الأرباح والأموال المتاحة محسوبة تلقائياً

### 3. التصفية والترتيب
- **ترتيب حسب الأرباح**: أعلى/أقل ربح
- **ترتيب حسب الأموال المتاحة**: أعلى/أقل مبلغ
- **تصفية حسب الأرباح**: رابحة، خاسرة، عالية الربح

### 4. عرض البيانات في الجدول
- عمود الأرباح: أخضر للربح، أحمر للخسارة
- عمود الأموال المتاحة: يعرض المبلغ المحصل

## الصيغ الحسابية

### حساب ربح الفاتورة
```javascript
totalProfit = invoiceItems.reduce((sum, item) => {
  const itemCost = item.quantity * product.unit_cost
  const itemRevenue = item.line_total
  return sum + (itemRevenue - itemCost)
}, 0)
```

### حساب الأموال المتاحة
```javascript
availableFunds = invoice.total_amount // المبلغ الإجمالي المحصل
```

## ملاحظات مهمة

1. **تكلفة المنتج**: يجب إدخال تكلفة الشراء لكل منتج
2. **حساب تلقائي**: الأرباح والأموال المتاحة تُحسب تلقائياً
3. **تحديث البيانات**: عند تغيير تكلفة المنتج، يتم إعادة حساب الأرباح
4. **الأداء**: تم إضافة فهارس لتحسين الأداء

## استكشاف الأخطاء

### إذا لم تظهر الأرباح
1. تأكد من وجود عمود `unit_cost` في جدول `products`
2. تأكد من أن تكلفة المنتج أكبر من صفر
3. تحقق من وجود بيانات في جدول `invoice_items`

### إذا كانت الأرباح صفر
1. تحقق من تكلفة المنتج
2. تأكد من صحة بيانات الفواتير
3. راجع سجلات الأخطاء في المتصفح

## التطوير المستقبلي

- إضافة تقارير الأرباح الشهرية
- تحليل الأرباح حسب نوع المنتج
- مقارنة الأرباح عبر الفترات الزمنية
- تنبيهات الأرباح المنخفضة

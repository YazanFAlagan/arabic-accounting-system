# تحسينات نظام المخزون والمبيعات
## Inventory and Sales System Enhancements

### نظرة عامة
تم تطوير نظام المخزون والمبيعات ليدعم:
- **تسجيل المنتج مرة واحدة فقط** مع أسعار متعددة (جملة، قطاعي، محلات)
- **نظام مبيعات محسن** يسأل عن نوع البيع ويسمح بتطبيق الخصومات
- **حساب تلقائي للأسعار** حسب نوع البيع المختار
- **إدارة الخصومات** بنسبة مئوية أو مبلغ ثابت

### خطوات التطبيق

#### 1. تحديث قاعدة البيانات
قم بتشغيل الملف SQL التالي في Supabase:
```bash
# تطبيق التحديثات على قاعدة البيانات
psql -h [SUPABASE_HOST] -U postgres -d postgres -f database/update_products_schema.sql
```

أو قم بنسخ ولصق محتويات `database/update_products_schema.sql` في SQL Editor في Supabase.

#### 2. التحديثات المطبقة

##### جدول المنتجات (products)
- ✅ إضافة عمود `retail_price` (سعر القطاعي)
- ✅ إضافة عمود `shop_price` (سعر المحلات) 
- ✅ الاحتفاظ بـ `wholesale_price` (سعر الجملة)
- ✅ الاحتفاظ بـ `selling_price` للتوافق مع النظام القديم

##### جدول المبيعات (sales)
- ✅ إضافة عمود `sale_type` (نوع البيع: wholesale/retail/shop)
- ✅ إضافة عمود `original_unit_price` (السعر الأصلي)
- ✅ إضافة عمود `discount_percentage` (نسبة الخصم %)
- ✅ إضافة عمود `discount_amount` (مبلغ الخصم)
- ✅ إضافة عمود `final_unit_price` (السعر النهائي)

##### الدوال المساعدة
- ✅ دالة `get_product_price()` لحساب السعر حسب نوع البيع
- ✅ دالة `calculate_final_price()` لحساب السعر النهائي مع الخصم
- ✅ محفز `trigger_update_stock_on_sale` لتحديث المخزون تلقائياً
- ✅ عرض `products_price_report` لتقارير الأسعار وهوامش الربح

### الميزات الجديدة

#### 1. إدارة المنتجات المحسنة
- **تسجيل واحد للمنتج** مع ثلاثة أسعار مختلفة
- **عرض هوامش الربح** لكل نوع سعر
- **واجهة محسنة** تعرض جميع الأسعار في جدول واحد

#### 2. نظام المبيعات المطور
- **اختيار نوع البيع**: قطاعي، جملة، أو محلات
- **تحديث تلقائي للسعر** عند تغيير نوع البيع
- **نظام خصومات متقدم**:
  - خصم بنسبة مئوية
  - خصم بمبلغ ثابت
  - إمكانية الجمع بين النوعين
- **ملخص فاتورة تفصيلي** يعرض:
  - السعر الأصلي
  - تفاصيل الخصم
  - السعر النهائي

#### 3. حسابات تلقائية
- **حساب السعر** حسب نوع البيع المختار
- **حساب الخصم** تلقائياً (نسبة + مبلغ)
- **حساب المجموع النهائي** مع جميع الخصومات
- **تحديث المخزون** تلقائياً عند البيع

### واجهة المستخدم

#### صفحة المخزون
- ✅ نموذج إضافة منتج محسن مع ثلاثة أسعار
- ✅ جدول يعرض جميع الأسعار وهوامش الربح
- ✅ عرض هوامش الربح ملونة (أخضر للقطاعي، أزرق للمحلات)

#### صفحة المبيعات  
- ✅ اختيار نوع البيع (قطاعي/جملة/محلات)
- ✅ تحديث السعر تلقائياً عند تغيير النوع
- ✅ قسم الخصومات مع حقلين منفصلين
- ✅ ملخص فاتورة تفصيلي مع المجموع النهائي

### اختبار النظام

#### 1. اختبار إضافة منتج
1. اذهب إلى صفحة المخزون
2. اضغط "إضافة منتج جديد"
3. أدخل اسم المنتج
4. أدخل سعر الجملة (مثال: 50 جنيه)
5. أدخل سعر القطاعي (مثال: 70 جنيه)
6. أدخل سعر المحلات (مثال: 60 جنيه)
7. أدخل الكمية وحد التنبيه
8. احفظ المنتج

#### 2. اختبار المبيعات
1. اذهب إلى صفحة المبيعات
2. اضغط "إضافة مبيعة جديدة"
3. اختر المنتج
4. اختر نوع البيع (لاحظ تغيير السعر تلقائياً)
5. أدخل الكمية
6. جرب إضافة خصم (نسبة أو مبلغ)
7. لاحظ ملخص الفاتورة
8. احفظ المبيعة

### الملفات المحدثة

#### قاعدة البيانات
- `database/update_products_schema.sql` - تحديثات قاعدة البيانات الكاملة

#### الواجهات
- `src/app/inventory/page.tsx` - صفحة المخزون المحسنة
- `src/app/sales/page.tsx` - صفحة المبيعات المطورة

### المتطلبات
- Next.js 13+
- Supabase
- TypeScript
- Tailwind CSS

### ملاحظات مهمة
1. **التوافق العكسي**: النظام يحافظ على التوافق مع البيانات القديمة
2. **الأمان**: جميع التحديثات تتم مع RLS policies
3. **الأداء**: تم إضافة فهارس للأعمدة الجديدة
4. **التحقق**: تم إضافة constraints للتأكد من صحة البيانات

### الدعم
في حالة وجود أي مشاكل، تأكد من:
- تطبيق جميع تحديثات قاعدة البيانات
- وجود الأعمدة الجديدة في الجداول
- عمل الدوال والمحفزات بشكل صحيح
